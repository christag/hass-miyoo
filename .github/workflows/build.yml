name: Build

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Minimal test binary for debugging display issues
  # Uses Ubuntu cross-compiler (glibc) with prebuilt SDL2+EGL+GLES from steward-fu/sdl2
  build-test-display:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install ARM cross-compiler
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf

    - name: Get SDL2 prebuilt libraries with MMIYOO driver
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps
        mkdir -p $DEPS/lib $DEPS/include/SDL2

        # Show toolchain info
        echo "=== Toolchain Info ==="
        arm-linux-gnueabihf-gcc --version

        # Clone steward-fu/sdl2 which has prebuilt libraries for Miyoo Mini
        # These are glibc-based libraries that work with the Ubuntu cross-compiler
        git clone --depth 1 https://github.com/steward-fu/sdl2.git SDL2-mmiyoo

        # Copy prebuilt libraries (already compiled for Miyoo Mini with glibc)
        cp SDL2-mmiyoo/prebuilt/mini/libSDL2-2.0.so.0 $DEPS/lib/
        cp SDL2-mmiyoo/prebuilt/mini/libEGL.so $DEPS/lib/
        cp SDL2-mmiyoo/prebuilt/mini/libGLESv2.so $DEPS/lib/

        # Copy SDL2 headers
        cp SDL2-mmiyoo/sdl2/include/*.h $DEPS/include/SDL2/

        # Create SDL_config.h from minimal config (needed for compilation)
        cp $DEPS/include/SDL2/SDL_config_minimal.h $DEPS/include/SDL2/SDL_config.h

        # Create libSDL2.so symlink for linking
        cd $DEPS/lib
        ln -sf libSDL2-2.0.so.0 libSDL2.so

        ls -la $DEPS/lib/
        echo "SDL2 prebuilt libraries with MMIYOO driver ready"

    - name: Build test_display
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        # Compile using prebuilt SDL2 with MMIYOO driver
        # Use -nostartfiles and dynamic linking to avoid glibc version issues
        arm-linux-gnueabihf-gcc \
          -march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard \
          -I$DEPS/include/SDL2 \
          -o test_display \
          src/test_display.c \
          -L$DEPS/lib \
          -Wl,-rpath,/mnt/SDCARD/App/test_display/lib \
          -Wl,--allow-shlib-undefined \
          -lSDL2

        # Check binary
        ls -la test_display
        file test_display || true

    - name: Create test package
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        mkdir -p release/test_display/lib
        cp test_display release/test_display/
        cp dist/test_display/launch.sh release/test_display/
        chmod +x release/test_display/launch.sh release/test_display/test_display

        # Bundle ALL prebuilt libraries (SDL2 + EGL + GLES - same as Moonlight uses)
        cp $DEPS/lib/libSDL2-2.0.so.0 release/test_display/lib/
        cp $DEPS/lib/libEGL.so release/test_display/lib/
        cp $DEPS/lib/libGLESv2.so release/test_display/lib/
        ls -la release/test_display/lib/

        cd release
        zip -r test_display.zip test_display/

    - name: Upload test_display artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-display-miyoo
        path: release/test_display.zip

  # Main HACompanion build using Ubuntu cross-compiler with glibc
  # The prebuilt SDL2 libraries from steward-fu/sdl2 are glibc-based,
  # so we must use a glibc-based cross-compiler for ABI compatibility
  build-miyoo-arm:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Install ARM cross-compiler and tools
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc-arm-linux-gnueabihf g++-arm-linux-gnueabihf cmake unzip

        echo "=== Cross-compiler Info ==="
        arm-linux-gnueabihf-gcc --version

    - name: Get SDL2 prebuilt libraries with MMIYOO driver
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps
        mkdir -p $DEPS/lib $DEPS/include/SDL2

        # Clone steward-fu/sdl2 which has prebuilt libraries for Miyoo Mini
        # These are glibc-based libraries that work with Ubuntu cross-compiler
        git clone --depth 1 https://github.com/steward-fu/sdl2.git SDL2-mmiyoo

        # Copy prebuilt libraries (already compiled for Miyoo Mini with glibc)
        cp SDL2-mmiyoo/prebuilt/mini/libSDL2-2.0.so.0 $DEPS/lib/
        cp SDL2-mmiyoo/prebuilt/mini/libEGL.so $DEPS/lib/
        cp SDL2-mmiyoo/prebuilt/mini/libGLESv2.so $DEPS/lib/

        # Copy SDL2 headers
        cp SDL2-mmiyoo/sdl2/include/*.h $DEPS/include/SDL2/

        # Create SDL_config.h from minimal config (needed for compilation)
        cp $DEPS/include/SDL2/SDL_config_minimal.h $DEPS/include/SDL2/SDL_config.h

        # Create libSDL2.so symlink for linking
        cd $DEPS/lib
        ln -sf libSDL2-2.0.so.0 libSDL2.so

        ls -la $DEPS/lib/
        echo "SDL2 prebuilt libraries with MMIYOO driver ready"

    - name: Build cJSON and SQLite
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        # cJSON
        wget -q https://github.com/DaveGamble/cJSON/archive/refs/tags/v1.7.16.tar.gz
        tar xzf v1.7.16.tar.gz
        cd cJSON-1.7.16
        arm-linux-gnueabihf-gcc -c cJSON.c -o cJSON.o -fPIC
        arm-linux-gnueabihf-ar rcs libcjson.a cJSON.o
        cp libcjson.a $DEPS/lib/
        mkdir -p $DEPS/include/cjson
        cp cJSON.h $DEPS/include/cjson/
        cd ..

        # SQLite3
        wget -q https://www.sqlite.org/2024/sqlite-amalgamation-3450000.zip
        unzip -q sqlite-amalgamation-3450000.zip
        cd sqlite-amalgamation-3450000
        arm-linux-gnueabihf-gcc -c sqlite3.c -o sqlite3.o -DSQLITE_OMIT_LOAD_EXTENSION -fPIC
        arm-linux-gnueabihf-ar rcs libsqlite3.a sqlite3.o
        cp libsqlite3.a $DEPS/lib/
        cp sqlite3.h sqlite3ext.h $DEPS/include/

    - name: Build Freetype and SDL2_ttf
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        # Freetype
        wget -q --timeout=120 https://downloads.sourceforge.net/project/freetype/freetype2/2.13.2/freetype-2.13.2.tar.gz
        tar xzf freetype-2.13.2.tar.gz
        cd freetype-2.13.2
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          --enable-shared --disable-static \
          --with-zlib=no --with-bzip2=no --with-png=no --with-harfbuzz=no --with-brotli=no
        make -j$(nproc)
        make install
        cd ..

        # SDL2_ttf - link against prebuilt SDL2
        wget -q https://github.com/libsdl-org/SDL_ttf/releases/download/release-2.20.2/SDL2_ttf-2.20.2.tar.gz
        tar xzf SDL2_ttf-2.20.2.tar.gz
        cd SDL2_ttf-2.20.2
        export PKG_CONFIG_PATH=$DEPS/lib/pkgconfig:$PKG_CONFIG_PATH
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          --enable-shared --disable-static \
          --disable-freetype-builtin \
          --disable-harfbuzz \
          CFLAGS="-I$DEPS/include/SDL2" \
          LDFLAGS="-L$DEPS/lib" \
          FREETYPE_CFLAGS="-I$DEPS/include/freetype2" \
          FREETYPE_LIBS="-L$DEPS/lib -lfreetype"
        make -j$(nproc)
        make install
        ls -la $DEPS/lib/libSDL2_ttf*
        echo "Freetype and SDL2_ttf complete"

    - name: Build SDL2_image, OpenSSL, and libcurl
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        # SDL2_image - link against prebuilt SDL2
        wget -q https://github.com/libsdl-org/SDL_image/releases/download/release-2.6.3/SDL2_image-2.6.3.tar.gz
        tar xzf SDL2_image-2.6.3.tar.gz
        cd SDL2_image-2.6.3
        export PKG_CONFIG_PATH=$DEPS/lib/pkgconfig:$PKG_CONFIG_PATH
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          --enable-shared --disable-static \
          --disable-jpg --disable-png-shared --disable-webp --disable-tif \
          CFLAGS="-I$DEPS/include/SDL2" \
          LDFLAGS="-L$DEPS/lib"
        make -j$(nproc)
        make install
        cd ..

        # OpenSSL (for HTTPS support in libcurl)
        wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
        tar xzf openssl-1.1.1w.tar.gz
        cd openssl-1.1.1w
        ./Configure linux-armv4 --prefix=$DEPS \
          --openssldir=$DEPS/ssl \
          no-shared no-tests \
          --cross-compile-prefix=arm-linux-gnueabihf-
        make -j$(nproc)
        make install_sw
        cd ..

        # libcurl with OpenSSL
        wget -q https://curl.se/download/curl-8.5.0.tar.gz
        tar xzf curl-8.5.0.tar.gz
        cd curl-8.5.0
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          --disable-shared --enable-static \
          --with-openssl=$DEPS \
          --without-zlib --without-brotli --without-zstd \
          --without-libpsl --without-nghttp2 \
          --disable-ldap --disable-dict --disable-telnet --disable-tftp \
          --disable-pop3 --disable-imap --disable-smtp --disable-gopher \
          --disable-rtsp --disable-smb \
          LDFLAGS="-L$DEPS/lib" \
          CPPFLAGS="-I$DEPS/include"
        make -j$(nproc)
        make install

        echo "=== Installed dependencies ==="
        ls -la $DEPS/lib/

    - name: Build hacompanion for Miyoo ARM
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        mkdir -p build-arm
        cd build-arm

        export PKG_CONFIG_PATH=$DEPS/lib/pkgconfig

        # Build with Ubuntu glibc cross-compiler (matches prebuilt SDL2 libraries)
        cmake -DCMAKE_C_COMPILER=arm-linux-gnueabihf-gcc \
              -DCMAKE_CXX_COMPILER=arm-linux-gnueabihf-g++ \
              -DCMAKE_FIND_ROOT_PATH="$DEPS" \
              -DCMAKE_PREFIX_PATH="$DEPS" \
              -DCMAKE_C_FLAGS="-march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard -I$DEPS/include -I$DEPS/include/SDL2" \
              -DCMAKE_EXE_LINKER_FLAGS="-L$DEPS/lib -Wl,-rpath,/mnt/SDCARD/App/HACompanion/lib -Wl,--allow-shlib-undefined" \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        make -j$(nproc) VERBOSE=1

        # Check binary info
        ls -la hacompanion
        file hacompanion || true

    - name: Create Miyoo package
      run: |
        set -ex
        export DEPS=$GITHUB_WORKSPACE/deps

        mkdir -p release/HACompanion/lib
        cp build-arm/hacompanion release/HACompanion/
        cp -r assets release/HACompanion/
        cp assets/icon.png release/HACompanion/icon.png

        # Bundle ALL prebuilt libraries (SDL2 + EGL + GLES - same as Moonlight uses)
        cp $DEPS/lib/libSDL2-2.0.so.0 release/HACompanion/lib/ || true
        cp $DEPS/lib/libEGL.so release/HACompanion/lib/ || true
        cp $DEPS/lib/libGLESv2.so release/HACompanion/lib/ || true
        echo "Bundled SDL2 + EGL + GLES libraries with MMIYOO video driver"

        # Bundle all other shared SDL2 libraries we built
        cp $DEPS/lib/libSDL2_ttf-2.0.so.0 release/HACompanion/lib/ || true
        cp $DEPS/lib/libSDL2_image-2.0.so.0 release/HACompanion/lib/ || true
        cp $DEPS/lib/libfreetype.so.6 release/HACompanion/lib/ || true
        echo "Bundled SDL2_ttf, SDL2_image, and freetype shared libraries"

        ls -la release/HACompanion/lib/

        # Create launch script (modeled after working Moonlight app)
        cat > release/HACompanion/launch.sh << 'LAUNCH_EOF'
        #!/bin/sh
        # Home Assistant Companion launcher for Miyoo Mini Plus / OnionOS
        # Based on working Moonlight app launch script

        cd /mnt/SDCARD/App/HACompanion
        export HOME=/mnt/SDCARD/App/HACompanion

        # Set all video/audio drivers to mmiyoo (CRITICAL - Moonlight uses all three)
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo

        # Full library path matching OnionOS conventions
        export LD_LIBRARY_PATH="./lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte:$LD_LIBRARY_PATH"

        # Run the application
        ./hacompanion 2>&1 | tee debug.log
        LAUNCH_EOF
        chmod +x release/HACompanion/launch.sh

        # Create debug launch script (run via SSH/telnet)
        cat > release/HACompanion/launch_debug.sh << 'LAUNCH_EOF'
        #!/bin/sh
        cd /mnt/SDCARD/App/HACompanion
        echo "=== HACompanion Debug Launch ===" | tee debug.log
        echo "Date: $(date)" | tee -a debug.log

        export HOME=/mnt/SDCARD/App/HACompanion
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo
        export LD_LIBRARY_PATH="./lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte:$LD_LIBRARY_PATH"

        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH" | tee -a debug.log
        echo "SDL_VIDEODRIVER: $SDL_VIDEODRIVER" | tee -a debug.log
        echo "SDL_AUDIODRIVER: $SDL_AUDIODRIVER" | tee -a debug.log
        echo "EGL_VIDEODRIVER: $EGL_VIDEODRIVER" | tee -a debug.log
        echo "Starting app..." | tee -a debug.log
        ./hacompanion 2>&1 | tee -a debug.log
        echo "Exit code: $?" | tee -a debug.log
        LAUNCH_EOF
        chmod +x release/HACompanion/launch_debug.sh

        # Create config.json for OnionOS
        cat > release/HACompanion/config.json << 'LAUNCH_EOF'
        {
          "label": "HA Companion",
          "icon": "icon.png",
          "launch": "launch.sh",
          "description": "Home Assistant Companion"
        }
        LAUNCH_EOF

        # Create sample servers.json
        cat > release/HACompanion/servers.json.example << 'LAUNCH_EOF'
        {
          "servers": [
            {
              "name": "Home",
              "url": "http://homeassistant.local",
              "port": 8123,
              "token": "YOUR_LONG_LIVED_ACCESS_TOKEN_HERE",
              "username": "admin",
              "insecure": 1
            }
          ],
          "default_server": 0
        }
        LAUNCH_EOF

        cd release
        zip -r HACompanion-miyoo.zip HACompanion/

    - name: Upload Miyoo ARM artifact
      uses: actions/upload-artifact@v4
      with:
        name: HACompanion-miyoo-arm
        path: release/HACompanion-miyoo.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libcjson-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-linux-x86_64
        path: build/hacompanion

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install sdl2 sdl2_image sdl2_ttf curl sqlite cjson

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-macos
        path: build/hacompanion

  # Update v0.1.0 release with latest main branch builds
  update-dev-release:
    needs: [build-test-display, build-miyoo-arm, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        cd artifacts
        # Rename and organize files
        mv HACompanion-miyoo-arm/HACompanion-miyoo.zip ./HACompanion-miyoo.zip
        mv test-display-miyoo/test_display.zip ./test_display-miyoo.zip
        mv hacompanion-linux-x86_64/hacompanion ./hacompanion-linux-x86_64-binary
        mv hacompanion-macos/hacompanion ./hacompanion-macos-binary
        chmod +x hacompanion-linux-x86_64-binary hacompanion-macos-binary
        ls -la

    - name: Update v0.1.0 release
      run: |
        # Delete old assets
        gh release delete-asset v0.1.0 HACompanion-miyoo.zip --yes || true
        gh release delete-asset v0.1.0 test_display-miyoo.zip --yes || true
        gh release delete-asset v0.1.0 hacompanion-linux-x86_64-binary --yes || true
        gh release delete-asset v0.1.0 hacompanion-macos-binary --yes || true

        # Upload new assets
        gh release upload v0.1.0 \
          artifacts/HACompanion-miyoo.zip \
          artifacts/test_display-miyoo.zip \
          artifacts/hacompanion-linux-x86_64-binary \
          artifacts/hacompanion-macos-binary \
          --clobber

        echo "Updated v0.1.0 release with latest main branch builds"
      env:
        GH_TOKEN: ${{ github.token }}

  # Create versioned releases from tags
  release:
    needs: [build-miyoo-arm, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        cd artifacts
        # Rename and organize files
        mv HACompanion-miyoo-arm/HACompanion-miyoo.zip ./HACompanion-miyoo-${{ github.ref_name }}.zip
        mv hacompanion-linux-x86_64/hacompanion ./hacompanion-linux-x86_64-binary
        mv hacompanion-macos/hacompanion ./hacompanion-macos-binary
        chmod +x hacompanion-linux-x86_64-binary hacompanion-macos-binary
        ls -la

    - name: Create Release using gh CLI
      run: |
        # Delete release if it already exists
        gh release delete ${{ github.ref_name }} --yes || true

        gh release create ${{ github.ref_name }} \
          --title "HACompanion ${{ github.ref_name }}" \
          --generate-notes \
          artifacts/HACompanion-miyoo-${{ github.ref_name }}.zip \
          artifacts/hacompanion-linux-x86_64-binary \
          artifacts/hacompanion-macos-binary
      env:
        GH_TOKEN: ${{ github.token }}
