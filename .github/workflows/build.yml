name: Build

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Minimal test binary for debugging display issues
  # Uses shauninman/union-miyoomini-toolchain Docker image for proper ABI compatibility
  # This toolchain has SDL2 built into the sysroot, ensuring binary and library match
  build-test-display:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Build test_display using Miyoo toolchain Docker
      run: |
        set -ex

        # Use shauninman's union-miyoomini-toolchain Docker image
        # This is the official toolchain used by MinUI and other working Miyoo apps
        # SDL2 is already compiled in the sysroot with proper MMIYOO driver
        docker run --rm -v $PWD:/work shauninman/union-miyoomini-toolchain:latest /bin/bash -c '
          set -ex
          cd /work

          # Toolchain paths (as discovered from XK9274/miyoo_sdl2_benchmarks)
          export CROSS_PREFIX=/opt/miyoomini-toolchain/usr/bin/arm-linux-gnueabihf-
          export SYSROOT=/opt/miyoomini-toolchain/usr/arm-linux-gnueabihf/sysroot
          export SDL_INCLUDE=$SYSROOT/usr/include/SDL2
          export SDL_LIBDIR=$SYSROOT/usr/lib

          echo "=== Toolchain Info ==="
          ${CROSS_PREFIX}gcc --version

          echo "=== SDL2 in sysroot ==="
          ls -la $SDL_LIBDIR/libSDL2* || echo "Checking alternate locations..."
          ls -la $SYSROOT/lib/libSDL2* || echo "Not in /lib either"
          find $SYSROOT -name "libSDL2*" 2>/dev/null || echo "SDL2 search complete"

          echo "=== SDL2 headers ==="
          ls $SDL_INCLUDE/*.h | head -5 || echo "Headers location may differ"
          find $SYSROOT -name "SDL.h" 2>/dev/null

          # Compile test_display using toolchain SDL2
          ${CROSS_PREFIX}gcc \
            -march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard \
            --sysroot=$SYSROOT \
            -I$SDL_INCLUDE \
            -o test_display \
            src/test_display.c \
            -L$SDL_LIBDIR \
            -Wl,-rpath,/mnt/SDCARD/App/test_display/lib \
            -lSDL2

          echo "=== Binary info ==="
          ls -la test_display
          file test_display

          # Check what libraries the binary needs
          ${CROSS_PREFIX}readelf -d test_display | grep NEEDED || true
        '

    - name: Create test package
      run: |
        set -ex

        mkdir -p release/test_display/lib
        cp test_display release/test_display/
        cp dist/test_display/launch.sh release/test_display/
        chmod +x release/test_display/launch.sh release/test_display/test_display

        # Extract SDL2 library from the toolchain sysroot
        # This ensures the library and binary are from the same toolchain
        docker run --rm -v $PWD:/work shauninman/union-miyoomini-toolchain:latest /bin/bash -c '
          set -ex
          SYSROOT=/opt/miyoomini-toolchain/usr/arm-linux-gnueabihf/sysroot

          # Find and copy SDL2 library
          SDL2_LIB=$(find $SYSROOT -name "libSDL2*.so*" -type f | head -1)
          if [ -n "$SDL2_LIB" ]; then
            cp -L $SDL2_LIB /work/release/test_display/lib/libSDL2-2.0.so.0
          fi

          # Also copy any EGL/GLES libraries if present
          find $SYSROOT -name "libEGL.so*" -type f -exec cp -L {} /work/release/test_display/lib/ \; 2>/dev/null || true
          find $SYSROOT -name "libGLES*.so*" -type f -exec cp -L {} /work/release/test_display/lib/ \; 2>/dev/null || true

          ls -la /work/release/test_display/lib/
        '

        cd release
        zip -r test_display.zip test_display/

    - name: Upload test_display artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-display-miyoo
        path: release/test_display.zip

  # Main HACompanion build using shauninman/union-miyoomini-toolchain Docker image
  # This toolchain has SDL2 built into the sysroot, ensuring binary and library match
  # Critical for avoiding the ABI mismatch that caused the black screen issue
  build-miyoo-arm:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Build HACompanion using Miyoo toolchain Docker
      run: |
        set -ex

        # Use shauninman's union-miyoomini-toolchain Docker image
        # This is the official toolchain used by MinUI and other working Miyoo apps
        docker run --rm -v $PWD:/work shauninman/union-miyoomini-toolchain:latest /bin/bash -c '
          set -ex
          cd /work

          # Toolchain paths
          export CROSS_PREFIX=/opt/miyoomini-toolchain/usr/bin/arm-linux-gnueabihf-
          export SYSROOT=/opt/miyoomini-toolchain/usr/arm-linux-gnueabihf/sysroot
          export DEPS=/work/deps

          mkdir -p $DEPS/lib $DEPS/include

          echo "=== Toolchain Info ==="
          ${CROSS_PREFIX}gcc --version

          echo "=== Finding SDL2 in sysroot ==="
          SDL2_LIB_PATH=""
          SDL2_INC_PATH=""

          # Find SDL2 library
          for path in $SYSROOT/usr/lib $SYSROOT/lib; do
            if [ -f "$path/libSDL2.so" ] || [ -f "$path/libSDL2-2.0.so.0" ]; then
              SDL2_LIB_PATH=$path
              break
            fi
          done

          # Find SDL2 headers
          for path in $SYSROOT/usr/include/SDL2 $SYSROOT/include/SDL2; do
            if [ -f "$path/SDL.h" ]; then
              SDL2_INC_PATH=$path
              break
            fi
          done

          # Fallback: search everywhere
          if [ -z "$SDL2_LIB_PATH" ]; then
            SDL2_SO=$(find $SYSROOT -name "libSDL2*.so*" -type f 2>/dev/null | head -1)
            if [ -n "$SDL2_SO" ]; then
              SDL2_LIB_PATH=$(dirname "$SDL2_SO")
            fi
          fi

          if [ -z "$SDL2_INC_PATH" ]; then
            SDL_H=$(find $SYSROOT -name "SDL.h" 2>/dev/null | head -1)
            if [ -n "$SDL_H" ]; then
              SDL2_INC_PATH=$(dirname "$SDL_H")
            fi
          fi

          echo "SDL2 library path: $SDL2_LIB_PATH"
          echo "SDL2 include path: $SDL2_INC_PATH"
          ls -la $SDL2_LIB_PATH/libSDL2* || true
          ls $SDL2_INC_PATH/*.h | head -5 || true

          # Build cJSON (static)
          echo "=== Building cJSON ==="
          wget -q https://github.com/DaveGamble/cJSON/archive/refs/tags/v1.7.16.tar.gz
          tar xzf v1.7.16.tar.gz
          cd cJSON-1.7.16
          ${CROSS_PREFIX}gcc --sysroot=$SYSROOT -c cJSON.c -o cJSON.o -fPIC
          ${CROSS_PREFIX}ar rcs libcjson.a cJSON.o
          cp libcjson.a $DEPS/lib/
          mkdir -p $DEPS/include/cjson
          cp cJSON.h $DEPS/include/cjson/
          cd ..

          # Build SQLite3 (static)
          echo "=== Building SQLite3 ==="
          wget -q https://www.sqlite.org/2024/sqlite-amalgamation-3450000.zip
          unzip -q sqlite-amalgamation-3450000.zip
          cd sqlite-amalgamation-3450000
          ${CROSS_PREFIX}gcc --sysroot=$SYSROOT -c sqlite3.c -o sqlite3.o -DSQLITE_OMIT_LOAD_EXTENSION -fPIC
          ${CROSS_PREFIX}ar rcs libsqlite3.a sqlite3.o
          cp libsqlite3.a $DEPS/lib/
          cp sqlite3.h sqlite3ext.h $DEPS/include/
          cd ..

          # Build Freetype (shared, for SDL2_ttf)
          echo "=== Building Freetype ==="
          wget -q --timeout=120 https://downloads.sourceforge.net/project/freetype/freetype2/2.13.2/freetype-2.13.2.tar.gz || \
            wget -q https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.gz
          tar xzf freetype-2.13.2.tar.gz
          cd freetype-2.13.2
          ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
            CC="${CROSS_PREFIX}gcc --sysroot=$SYSROOT" \
            --enable-shared --disable-static \
            --with-zlib=no --with-bzip2=no --with-png=no --with-harfbuzz=no --with-brotli=no
          make -j$(nproc)
          make install
          cd ..

          # Build SDL2_ttf (shared)
          echo "=== Building SDL2_ttf ==="
          wget -q https://github.com/libsdl-org/SDL_ttf/releases/download/release-2.20.2/SDL2_ttf-2.20.2.tar.gz
          tar xzf SDL2_ttf-2.20.2.tar.gz
          cd SDL2_ttf-2.20.2
          export PKG_CONFIG_PATH=$DEPS/lib/pkgconfig:$SDL2_LIB_PATH/pkgconfig:$PKG_CONFIG_PATH
          ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
            CC="${CROSS_PREFIX}gcc --sysroot=$SYSROOT" \
            --enable-shared --disable-static \
            --disable-freetype-builtin \
            --disable-harfbuzz \
            --disable-sdltest \
            CFLAGS="-I$SDL2_INC_PATH -I$DEPS/include/freetype2" \
            LDFLAGS="-L$SDL2_LIB_PATH -L$DEPS/lib -Wl,--allow-shlib-undefined" \
            FREETYPE_CFLAGS="-I$DEPS/include/freetype2" \
            FREETYPE_LIBS="-L$DEPS/lib -lfreetype"
          make -j$(nproc) libSDL2_ttf.la
          cp -a .libs/libSDL2_ttf*.so* $DEPS/lib/
          cp SDL_ttf.h $DEPS/include/
          cd ..

          # Build SDL2_image (shared)
          echo "=== Building SDL2_image ==="
          wget -q https://github.com/libsdl-org/SDL_image/releases/download/release-2.6.3/SDL2_image-2.6.3.tar.gz
          tar xzf SDL2_image-2.6.3.tar.gz
          cd SDL2_image-2.6.3
          ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
            CC="${CROSS_PREFIX}gcc --sysroot=$SYSROOT" \
            --enable-shared --disable-static \
            --disable-sdltest \
            --disable-jpg --disable-png-shared --disable-webp --disable-tif \
            CFLAGS="-I$SDL2_INC_PATH" \
            LDFLAGS="-L$SDL2_LIB_PATH -L$DEPS/lib -Wl,--allow-shlib-undefined"
          make -j$(nproc) libSDL2_image.la
          cp -a .libs/libSDL2_image*.so* $DEPS/lib/
          cp SDL_image.h $DEPS/include/
          cd ..

          # Build OpenSSL (static, for curl)
          echo "=== Building OpenSSL ==="
          wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
          tar xzf openssl-1.1.1w.tar.gz
          cd openssl-1.1.1w
          ./Configure linux-armv4 --prefix=$DEPS \
            --openssldir=$DEPS/ssl \
            no-shared no-tests \
            --cross-compile-prefix=${CROSS_PREFIX}
          make -j$(nproc)
          make install_sw
          cd ..

          # Build libcurl (static)
          echo "=== Building libcurl ==="
          wget -q https://curl.se/download/curl-8.5.0.tar.gz
          tar xzf curl-8.5.0.tar.gz
          cd curl-8.5.0
          ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
            CC="${CROSS_PREFIX}gcc --sysroot=$SYSROOT" \
            --disable-shared --enable-static \
            --with-openssl=$DEPS \
            --without-zlib --without-brotli --without-zstd \
            --without-libpsl --without-nghttp2 \
            --disable-ldap --disable-dict --disable-telnet --disable-tftp \
            --disable-pop3 --disable-imap --disable-smtp --disable-gopher \
            --disable-rtsp --disable-smb \
            LDFLAGS="-L$DEPS/lib" \
            CPPFLAGS="-I$DEPS/include"
          make -j$(nproc)
          make install
          cd ..

          echo "=== All dependencies built ==="
          ls -la $DEPS/lib/

          # Build HACompanion
          echo "=== Building HACompanion ==="
          mkdir -p build-arm
          cd build-arm

          # Direct compilation (avoid cmake cross-compile complexity)
          ${CROSS_PREFIX}gcc \
            -march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard \
            --sysroot=$SYSROOT \
            -I$SDL2_INC_PATH \
            -I$DEPS/include \
            -I$DEPS/include/freetype2 \
            -I../src \
            -o hacompanion \
            ../src/main.c \
            ../src/ha_client.c \
            ../src/database.c \
            ../src/cache_manager.c \
            ../src/audio.c \
            ../src/ui/fonts.c \
            ../src/ui/icons.c \
            ../src/ui/components.c \
            ../src/screens/screen_setup.c \
            ../src/screens/screen_list.c \
            ../src/screens/screen_device.c \
            ../src/screens/screen_info.c \
            ../src/screens/screen_automation.c \
            ../src/screens/screen_script.c \
            ../src/screens/screen_scene.c \
            ../src/utils/input.c \
            ../src/utils/config.c \
            ../src/utils/json_helpers.c \
            -L$SDL2_LIB_PATH \
            -L$DEPS/lib \
            -Wl,-rpath,/mnt/SDCARD/App/HACompanion/lib \
            -lSDL2 -lSDL2_ttf -lSDL2_image \
            -lfreetype \
            -lcurl -lssl -lcrypto \
            -lsqlite3 -lcjson \
            -lpthread -ldl -lm

          echo "=== Binary info ==="
          ls -la hacompanion
          file hacompanion
          ${CROSS_PREFIX}readelf -d hacompanion | grep NEEDED || true

          # Save SDL2 library path for packaging step
          echo "$SDL2_LIB_PATH" > /work/SDL2_LIB_PATH.txt
        '

    - name: Create Miyoo package
      run: |
        set -ex

        mkdir -p release/HACompanion/lib
        cp build-arm/hacompanion release/HACompanion/
        cp -r assets release/HACompanion/
        cp assets/icon.png release/HACompanion/icon.png

        # Bundle libraries from toolchain (ensures ABI compatibility)
        docker run --rm -v $PWD:/work shauninman/union-miyoomini-toolchain:latest /bin/bash -c '
          set -ex
          SYSROOT=/opt/miyoomini-toolchain/usr/arm-linux-gnueabihf/sysroot
          SDL2_LIB_PATH=$(cat /work/SDL2_LIB_PATH.txt)

          # Copy SDL2 and related from sysroot
          if [ -n "$SDL2_LIB_PATH" ]; then
            cp -L $SDL2_LIB_PATH/libSDL2-2.0.so.0 /work/release/HACompanion/lib/ 2>/dev/null || \
              cp -L $SDL2_LIB_PATH/libSDL2.so /work/release/HACompanion/lib/libSDL2-2.0.so.0
          fi

          # Copy EGL/GLES if present in sysroot
          find $SYSROOT -name "libEGL.so*" -type f -exec cp -L {} /work/release/HACompanion/lib/ \; 2>/dev/null || true
          find $SYSROOT -name "libGLESv2.so*" -type f -exec cp -L {} /work/release/HACompanion/lib/ \; 2>/dev/null || true

          # Copy our built shared libraries
          cp -L /work/deps/lib/libSDL2_ttf-2.0.so.0 /work/release/HACompanion/lib/ 2>/dev/null || \
            cp -L /work/deps/lib/libSDL2_ttf.so.0 /work/release/HACompanion/lib/libSDL2_ttf-2.0.so.0
          cp -L /work/deps/lib/libSDL2_image-2.0.so.0 /work/release/HACompanion/lib/ 2>/dev/null || \
            cp -L /work/deps/lib/libSDL2_image.so.0 /work/release/HACompanion/lib/libSDL2_image-2.0.so.0
          cp -L /work/deps/lib/libfreetype.so.6 /work/release/HACompanion/lib/

          ls -la /work/release/HACompanion/lib/
        '

        # Create launch script
        cat > release/HACompanion/launch.sh << 'LAUNCH_EOF'
        #!/bin/sh
        # Home Assistant Companion launcher for Miyoo Mini Plus / OnionOS

        cd /mnt/SDCARD/App/HACompanion
        export HOME=/mnt/SDCARD/App/HACompanion

        # Set all video/audio drivers to mmiyoo
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo

        # Use our bundled libraries first, then system libraries
        export LD_LIBRARY_PATH="./lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte:$LD_LIBRARY_PATH"

        # Run the application
        ./hacompanion 2>&1 | tee debug.log
        LAUNCH_EOF
        # Remove leading whitespace from heredoc
        sed -i 's/^        //' release/HACompanion/launch.sh
        chmod +x release/HACompanion/launch.sh

        # Create debug launch script
        cat > release/HACompanion/launch_debug.sh << 'LAUNCH_EOF'
        #!/bin/sh
        cd /mnt/SDCARD/App/HACompanion
        echo "=== HACompanion Debug Launch ===" | tee debug.log
        echo "Date: $(date)" | tee -a debug.log

        export HOME=/mnt/SDCARD/App/HACompanion
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo
        export LD_LIBRARY_PATH="./lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte:$LD_LIBRARY_PATH"

        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH" | tee -a debug.log
        echo "Starting app..." | tee -a debug.log
        ./hacompanion 2>&1 | tee -a debug.log
        echo "Exit code: $?" | tee -a debug.log
        LAUNCH_EOF
        sed -i 's/^        //' release/HACompanion/launch_debug.sh
        chmod +x release/HACompanion/launch_debug.sh

        # Create config.json for OnionOS
        cat > release/HACompanion/config.json << 'LAUNCH_EOF'
        {
          "label": "HA Companion",
          "icon": "icon.png",
          "launch": "launch.sh",
          "description": "Home Assistant Companion"
        }
        LAUNCH_EOF
        sed -i 's/^        //' release/HACompanion/config.json

        # Create sample servers.json
        cat > release/HACompanion/servers.json.example << 'LAUNCH_EOF'
        {
          "servers": [
            {
              "name": "Home",
              "url": "http://homeassistant.local",
              "port": 8123,
              "token": "YOUR_LONG_LIVED_ACCESS_TOKEN_HERE",
              "username": "admin",
              "insecure": 1
            }
          ],
          "default_server": 0
        }
        LAUNCH_EOF
        sed -i 's/^        //' release/HACompanion/servers.json.example

        cd release
        zip -r HACompanion-miyoo.zip HACompanion/

    - name: Upload Miyoo ARM artifact
      uses: actions/upload-artifact@v4
      with:
        name: HACompanion-miyoo-arm
        path: release/HACompanion-miyoo.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libcjson-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-linux-x86_64
        path: build/hacompanion

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install sdl2 sdl2_image sdl2_ttf curl sqlite cjson

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-macos
        path: build/hacompanion

  # Update v0.1.0 release with latest main branch builds
  update-dev-release:
    needs: [build-test-display, build-miyoo-arm, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        cd artifacts
        # Rename and organize files
        mv HACompanion-miyoo-arm/HACompanion-miyoo.zip ./HACompanion-miyoo.zip
        mv test-display-miyoo/test_display.zip ./test_display-miyoo.zip
        mv hacompanion-linux-x86_64/hacompanion ./hacompanion-linux-x86_64-binary
        mv hacompanion-macos/hacompanion ./hacompanion-macos-binary
        chmod +x hacompanion-linux-x86_64-binary hacompanion-macos-binary
        ls -la

    - name: Update v0.1.0 release
      run: |
        # Delete old assets
        gh release delete-asset v0.1.0 HACompanion-miyoo.zip --yes || true
        gh release delete-asset v0.1.0 test_display-miyoo.zip --yes || true
        gh release delete-asset v0.1.0 hacompanion-linux-x86_64-binary --yes || true
        gh release delete-asset v0.1.0 hacompanion-macos-binary --yes || true

        # Upload new assets
        gh release upload v0.1.0 \
          artifacts/HACompanion-miyoo.zip \
          artifacts/test_display-miyoo.zip \
          artifacts/hacompanion-linux-x86_64-binary \
          artifacts/hacompanion-macos-binary \
          --clobber

        echo "Updated v0.1.0 release with latest main branch builds"
      env:
        GH_TOKEN: ${{ github.token }}

  # Create versioned releases from tags
  release:
    needs: [build-miyoo-arm, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        cd artifacts
        # Rename and organize files
        mv HACompanion-miyoo-arm/HACompanion-miyoo.zip ./HACompanion-miyoo-${{ github.ref_name }}.zip
        mv hacompanion-linux-x86_64/hacompanion ./hacompanion-linux-x86_64-binary
        mv hacompanion-macos/hacompanion ./hacompanion-macos-binary
        chmod +x hacompanion-linux-x86_64-binary hacompanion-macos-binary
        ls -la

    - name: Create Release using gh CLI
      run: |
        # Delete release if it already exists
        gh release delete ${{ github.ref_name }} --yes || true

        gh release create ${{ github.ref_name }} \
          --title "HACompanion ${{ github.ref_name }}" \
          --generate-notes \
          artifacts/HACompanion-miyoo-${{ github.ref_name }}.zip \
          artifacts/hacompanion-linux-x86_64-binary \
          artifacts/hacompanion-macos-binary
      env:
        GH_TOKEN: ${{ github.token }}
