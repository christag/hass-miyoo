name: Build

on:
  push:
    branches: [ main, master ]
    tags: [ 'v*' ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Download and cache the prebuilt Miyoo toolchain (shared by other jobs)
  # Uses shauninman's prebuilt toolchain from miyoomini-toolchain-buildroot
  setup-toolchain:
    runs-on: ubuntu-22.04

    steps:
    - name: Cache toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: miyoomini-toolchain.tar.xz
        key: miyoo-toolchain-v0.0.3

    - name: Download prebuilt Miyoo toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        set -ex
        # Download the prebuilt toolchain from shauninman's buildroot releases
        wget -q https://github.com/shauninman/miyoomini-toolchain-buildroot/releases/download/v0.0.3/miyoomini-toolchain.tar.xz

    - name: Upload toolchain artifact
      uses: actions/upload-artifact@v4
      with:
        name: miyoo-toolchain
        path: miyoomini-toolchain.tar.xz
        retention-days: 1

  # Minimal test binary for debugging display issues
  # Uses the Miyoo toolchain for proper ABI compatibility
  build-test-display:
    runs-on: ubuntu-22.04
    needs: setup-toolchain

    steps:
    - uses: actions/checkout@v4

    - name: Download toolchain
      uses: actions/download-artifact@v4
      with:
        name: miyoo-toolchain

    - name: Extract toolchain
      run: |
        set -ex
        sudo mkdir -p /opt
        sudo tar xf miyoomini-toolchain.tar.xz -C /opt
        ls -la /opt/

    - name: Build SDL2 with MMIYOO driver
      run: |
        set -ex

        # Set up toolchain paths
        export CROSS_PREFIX=/opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-
        export SYSROOT=/opt/miyoomini-toolchain/arm-linux-gnueabihf/sysroot
        export DEPS=$PWD/deps
        mkdir -p $DEPS/lib $DEPS/include

        echo "=== Toolchain Info ==="
        ${CROSS_PREFIX}gcc --version

        # Build SDL2 with MMIYOO driver from steward-fu's fork
        # IMPORTANT: steward-fu/sdl2 (not sdl) has SDL2 with MMIYOO driver
        echo "=== Building SDL2 with MMIYOO driver ==="
        git clone --depth 1 https://github.com/steward-fu/sdl2.git sdl2-mmiyoo
        cd sdl2-mmiyoo/sdl2

        # Configure SDL2 for Miyoo Mini
        ./configure \
          --host=arm-linux-gnueabihf \
          --prefix=$DEPS \
          CC="${CROSS_PREFIX}gcc" \
          CXX="${CROSS_PREFIX}g++" \
          --enable-video-mmiyoo \
          --disable-video-opengl \
          --disable-video-opengles \
          --disable-video-x11 \
          --disable-video-wayland \
          --disable-video-vulkan \
          --disable-video-kmsdrm \
          --disable-video-dummy \
          --disable-pulseaudio \
          --disable-esd \
          --disable-arts \
          --disable-nas \
          --disable-sndio \
          --disable-jack \
          --disable-diskaudio \
          --disable-dummyaudio \
          --enable-shared \
          --disable-static

        make -j$(nproc)
        make install
        cd ../..

        echo "=== SDL2 built ==="
        ls -la $DEPS/lib/libSDL2*
        ls -la $DEPS/include/SDL2/

    - name: Build test_display
      run: |
        set -ex

        export CROSS_PREFIX=/opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-
        export DEPS=$PWD/deps

        # Compile test_display using our built SDL2
        ${CROSS_PREFIX}gcc \
          -march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard \
          -I$DEPS/include/SDL2 \
          -o test_display \
          src/test_display.c \
          -L$DEPS/lib \
          -Wl,-rpath,/mnt/SDCARD/App/test_display/lib \
          -lSDL2 -lpthread -ldl

        echo "=== Binary info ==="
        ls -la test_display
        file test_display

        # Check what libraries the binary needs
        ${CROSS_PREFIX}readelf -d test_display | grep NEEDED || true

    - name: Create test package
      run: |
        set -ex

        mkdir -p release/test_display/lib
        cp test_display release/test_display/
        cp dist/test_display/launch.sh release/test_display/
        chmod +x release/test_display/launch.sh release/test_display/test_display

        # Copy SDL2 library from our build
        cp -L deps/lib/libSDL2-2.0.so* release/test_display/lib/ 2>/dev/null || \
          cp -L deps/lib/libSDL2.so* release/test_display/lib/

        # Ensure expected filename exists
        cd release/test_display/lib/
        if [ ! -f libSDL2-2.0.so.0 ]; then
          # Find the actual library and create symlink
          SDL_LIB=$(ls libSDL2*.so* 2>/dev/null | head -1)
          if [ -n "$SDL_LIB" ]; then
            cp "$SDL_LIB" libSDL2-2.0.so.0
          fi
        fi
        ls -la

        cd ../..
        zip -r test_display.zip test_display/

    - name: Upload test_display artifact
      uses: actions/upload-artifact@v4
      with:
        name: test-display-miyoo
        path: release/test_display.zip

  # Main HACompanion build using prebuilt Miyoo toolchain
  # This toolchain has SDL2 built into the sysroot, ensuring binary and library match
  # Critical for avoiding the ABI mismatch that caused the black screen issue
  build-miyoo-arm:
    runs-on: ubuntu-22.04
    needs: setup-toolchain

    steps:
    - uses: actions/checkout@v4

    - name: Download toolchain
      uses: actions/download-artifact@v4
      with:
        name: miyoo-toolchain

    - name: Extract toolchain
      run: |
        set -ex
        sudo mkdir -p /opt
        sudo tar xf miyoomini-toolchain.tar.xz -C /opt
        ls -la /opt/

    - name: Build HACompanion using Miyoo toolchain
      run: |
        set -ex

        # Set up toolchain paths
        export CROSS_PREFIX=/opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-
        export SYSROOT=/opt/miyoomini-toolchain/arm-linux-gnueabihf/sysroot
        export DEPS=$PWD/deps
        mkdir -p $DEPS/lib $DEPS/include

        echo "=== Toolchain Info ==="
        ${CROSS_PREFIX}gcc --version

        # Build SDL2 with MMIYOO driver from steward-fu's fork
        # IMPORTANT: steward-fu/sdl2 (not sdl) has SDL2 with MMIYOO driver
        echo "=== Building SDL2 with MMIYOO driver ==="
        git clone --depth 1 https://github.com/steward-fu/sdl2.git sdl2-mmiyoo
        cd sdl2-mmiyoo/sdl2

        ./configure \
          --host=arm-linux-gnueabihf \
          --prefix=$DEPS \
          CC="${CROSS_PREFIX}gcc" \
          CXX="${CROSS_PREFIX}g++" \
          --enable-video-mmiyoo \
          --disable-video-opengl \
          --disable-video-opengles \
          --disable-video-x11 \
          --disable-video-wayland \
          --disable-video-vulkan \
          --disable-video-kmsdrm \
          --disable-video-dummy \
          --disable-pulseaudio \
          --disable-esd \
          --disable-arts \
          --disable-nas \
          --disable-sndio \
          --disable-jack \
          --disable-diskaudio \
          --disable-dummyaudio \
          --enable-shared \
          --disable-static

        make -j$(nproc)
        make install
        cd ../..

        echo "SDL2 built successfully:"
        ls -la $DEPS/lib/libSDL2*
        ls -la $DEPS/include/SDL2/

        # Set SDL2 paths for subsequent builds
        export SDL2_INC_PATH=$DEPS/include/SDL2
        export SDL2_LIB_PATH=$DEPS/lib

        # Build cJSON (static)
        echo "=== Building cJSON ==="
        wget -q https://github.com/DaveGamble/cJSON/archive/refs/tags/v1.7.16.tar.gz
        tar xzf v1.7.16.tar.gz
        cd cJSON-1.7.16
        ${CROSS_PREFIX}gcc -c cJSON.c -o cJSON.o -fPIC
        ${CROSS_PREFIX}ar rcs libcjson.a cJSON.o
        cp libcjson.a $DEPS/lib/
        mkdir -p $DEPS/include/cjson
        cp cJSON.h $DEPS/include/cjson/
        cd ..

        # Build SQLite3 (static)
        echo "=== Building SQLite3 ==="
        wget -q https://www.sqlite.org/2024/sqlite-amalgamation-3450000.zip
        unzip -q sqlite-amalgamation-3450000.zip
        cd sqlite-amalgamation-3450000
        ${CROSS_PREFIX}gcc -c sqlite3.c -o sqlite3.o -DSQLITE_OMIT_LOAD_EXTENSION -fPIC
        ${CROSS_PREFIX}ar rcs libsqlite3.a sqlite3.o
        cp libsqlite3.a $DEPS/lib/
        cp sqlite3.h sqlite3ext.h $DEPS/include/
        cd ..

        # Build Freetype (shared, for SDL2_ttf)
        echo "=== Building Freetype ==="
        wget -q --timeout=120 https://downloads.sourceforge.net/project/freetype/freetype2/2.13.2/freetype-2.13.2.tar.gz || \
          wget -q https://download.savannah.gnu.org/releases/freetype/freetype-2.13.2.tar.gz
        tar xzf freetype-2.13.2.tar.gz
        cd freetype-2.13.2
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          CC="${CROSS_PREFIX}gcc" \
          --enable-shared --disable-static \
          --with-zlib=no --with-bzip2=no --with-png=no --with-harfbuzz=no --with-brotli=no
        make -j$(nproc)
        make install
        cd ..

        # Build SDL2_ttf (shared)
        echo "=== Building SDL2_ttf ==="
        wget -q https://github.com/libsdl-org/SDL_ttf/releases/download/release-2.20.2/SDL2_ttf-2.20.2.tar.gz
        tar xzf SDL2_ttf-2.20.2.tar.gz
        cd SDL2_ttf-2.20.2
        export PKG_CONFIG_PATH=$DEPS/lib/pkgconfig:$SDL2_LIB_PATH/pkgconfig:$PKG_CONFIG_PATH
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          CC="${CROSS_PREFIX}gcc" \
          --enable-shared --disable-static \
          --disable-freetype-builtin \
          --disable-harfbuzz \
          --disable-sdltest \
          CFLAGS="-I$SDL2_INC_PATH -I$DEPS/include/freetype2" \
          LDFLAGS="-L$SDL2_LIB_PATH -L$DEPS/lib -Wl,--allow-shlib-undefined" \
          FREETYPE_CFLAGS="-I$DEPS/include/freetype2" \
          FREETYPE_LIBS="-L$DEPS/lib -lfreetype"
        make -j$(nproc) libSDL2_ttf.la
        cp -a .libs/libSDL2_ttf*.so* $DEPS/lib/
        cp SDL_ttf.h $DEPS/include/
        cd ..

        # Build SDL2_image (shared)
        echo "=== Building SDL2_image ==="
        wget -q https://github.com/libsdl-org/SDL_image/releases/download/release-2.6.3/SDL2_image-2.6.3.tar.gz
        tar xzf SDL2_image-2.6.3.tar.gz
        cd SDL2_image-2.6.3
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          CC="${CROSS_PREFIX}gcc" \
          --enable-shared --disable-static \
          --disable-sdltest \
          --disable-jpg --disable-png-shared --disable-webp --disable-tif \
          CFLAGS="-I$SDL2_INC_PATH" \
          LDFLAGS="-L$SDL2_LIB_PATH -L$DEPS/lib -Wl,--allow-shlib-undefined"
        make -j$(nproc) libSDL2_image.la
        cp -a .libs/libSDL2_image*.so* $DEPS/lib/
        cp SDL_image.h $DEPS/include/
        cd ..

        # Build OpenSSL (static, for curl)
        echo "=== Building OpenSSL ==="
        wget -q https://www.openssl.org/source/openssl-1.1.1w.tar.gz
        tar xzf openssl-1.1.1w.tar.gz
        cd openssl-1.1.1w
        ./Configure linux-armv4 --prefix=$DEPS \
          --openssldir=$DEPS/ssl \
          no-shared no-tests \
          --cross-compile-prefix=${CROSS_PREFIX}
        make -j$(nproc)
        make install_sw
        cd ..

        # Build libcurl (static)
        echo "=== Building libcurl ==="
        wget -q https://curl.se/download/curl-8.5.0.tar.gz
        tar xzf curl-8.5.0.tar.gz
        cd curl-8.5.0
        ./configure --host=arm-linux-gnueabihf --prefix=$DEPS \
          CC="${CROSS_PREFIX}gcc" \
          --disable-shared --enable-static \
          --with-openssl=$DEPS \
          --without-zlib --without-brotli --without-zstd \
          --without-libpsl --without-nghttp2 \
          --disable-ldap --disable-dict --disable-telnet --disable-tftp \
          --disable-pop3 --disable-imap --disable-smtp --disable-gopher \
          --disable-rtsp --disable-smb \
          LDFLAGS="-L$DEPS/lib" \
          CPPFLAGS="-I$DEPS/include"
        make -j$(nproc)
        make install
        cd ..

        echo "=== All dependencies built ==="
        ls -la $DEPS/lib/

        # Build HACompanion
        echo "=== Building HACompanion ==="
        mkdir -p build-arm
        cd build-arm

        # Direct compilation (avoid cmake cross-compile complexity)
        ${CROSS_PREFIX}gcc \
          -march=armv7-a -mtune=cortex-a7 -mfpu=neon-vfpv4 -mfloat-abi=hard \
          -I$SDL2_INC_PATH \
          -I$DEPS/include \
          -I$DEPS/include/freetype2 \
          -I../src \
          -o hacompanion \
          ../src/main.c \
          ../src/ha_client.c \
          ../src/database.c \
          ../src/cache_manager.c \
          ../src/audio.c \
          ../src/ui/fonts.c \
          ../src/ui/icons.c \
          ../src/ui/components.c \
          ../src/screens/screen_setup.c \
          ../src/screens/screen_list.c \
          ../src/screens/screen_device.c \
          ../src/screens/screen_info.c \
          ../src/screens/screen_automation.c \
          ../src/screens/screen_script.c \
          ../src/screens/screen_scene.c \
          ../src/utils/input.c \
          ../src/utils/config.c \
          ../src/utils/json_helpers.c \
          -L$SDL2_LIB_PATH \
          -L$DEPS/lib \
          -Wl,-rpath,/mnt/SDCARD/App/HACompanion/lib \
          -lSDL2 -lSDL2_ttf -lSDL2_image \
          -lfreetype \
          -lcurl -lssl -lcrypto \
          -lsqlite3 -lcjson \
          -lpthread -ldl -lm

        echo "=== Binary info ==="
        ls -la hacompanion
        file hacompanion
        ${CROSS_PREFIX}readelf -d hacompanion | grep NEEDED || true

        # Save SDL2 library path for packaging step
        echo "$SDL2_LIB_PATH" > ../SDL2_LIB_PATH.txt

    - name: Create Miyoo package
      run: |
        set -ex

        mkdir -p release/HACompanion/lib
        cp build-arm/hacompanion release/HACompanion/
        cp -r assets release/HACompanion/
        cp assets/icon.png release/HACompanion/icon.png

        # Bundle SDL2 library from our build (ensures ABI compatibility)
        cp -L deps/lib/libSDL2-2.0.so* release/HACompanion/lib/ 2>/dev/null || true
        # Ensure expected filename exists
        if [ ! -f release/HACompanion/lib/libSDL2-2.0.so.0 ]; then
          SDL_LIB=$(ls deps/lib/libSDL2*.so* 2>/dev/null | head -1)
          if [ -n "$SDL_LIB" ]; then
            cp -L "$SDL_LIB" release/HACompanion/lib/libSDL2-2.0.so.0
          fi
        fi

        # Copy our built shared libraries (SDL2_ttf, SDL2_image, freetype)
        cp -L deps/lib/libSDL2_ttf-2.0.so.0 release/HACompanion/lib/ 2>/dev/null || \
          cp -L deps/lib/libSDL2_ttf.so.0 release/HACompanion/lib/libSDL2_ttf-2.0.so.0 2>/dev/null || \
          cp -L deps/lib/libSDL2_ttf.so release/HACompanion/lib/libSDL2_ttf-2.0.so.0
        cp -L deps/lib/libSDL2_image-2.0.so.0 release/HACompanion/lib/ 2>/dev/null || \
          cp -L deps/lib/libSDL2_image.so.0 release/HACompanion/lib/libSDL2_image-2.0.so.0 2>/dev/null || \
          cp -L deps/lib/libSDL2_image.so release/HACompanion/lib/libSDL2_image-2.0.so.0
        cp -L deps/lib/libfreetype.so.6 release/HACompanion/lib/ 2>/dev/null || \
          cp -L deps/lib/libfreetype.so release/HACompanion/lib/libfreetype.so.6

        ls -la release/HACompanion/lib/

        # Create launch script
        cat > release/HACompanion/launch.sh << 'LAUNCHEOF'
        #!/bin/sh
        # Home Assistant Companion launcher for Miyoo Mini Plus / OnionOS

        cd /mnt/SDCARD/App/HACompanion
        export HOME=/mnt/SDCARD/App/HACompanion

        # Set all video/audio drivers to mmiyoo
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo

        # Use our bundled libraries first, then system libraries
        export LD_LIBRARY_PATH="./lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte:$LD_LIBRARY_PATH"

        # Run the application
        ./hacompanion 2>&1 | tee debug.log
        LAUNCHEOF
        sed -i 's/^        //' release/HACompanion/launch.sh
        chmod +x release/HACompanion/launch.sh

        # Create debug launch script
        cat > release/HACompanion/launch_debug.sh << 'DEBUGEOF'
        #!/bin/sh
        cd /mnt/SDCARD/App/HACompanion
        echo "=== HACompanion Debug Launch ===" | tee debug.log
        echo "Date: $(date)" | tee -a debug.log

        export HOME=/mnt/SDCARD/App/HACompanion
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo
        export LD_LIBRARY_PATH="./lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte:$LD_LIBRARY_PATH"

        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH" | tee -a debug.log
        echo "Starting app..." | tee -a debug.log
        ./hacompanion 2>&1 | tee -a debug.log
        echo "Exit code: $?" | tee -a debug.log
        DEBUGEOF
        sed -i 's/^        //' release/HACompanion/launch_debug.sh
        chmod +x release/HACompanion/launch_debug.sh

        # Create config.json for OnionOS
        cat > release/HACompanion/config.json << 'CONFIGEOF'
        {
          "label": "HA Companion",
          "icon": "icon.png",
          "launch": "launch.sh",
          "description": "Home Assistant Companion"
        }
        CONFIGEOF
        sed -i 's/^        //' release/HACompanion/config.json

        # Create sample servers.json
        cat > release/HACompanion/servers.json.example << 'SERVERSEOF'
        {
          "servers": [
            {
              "name": "Home",
              "url": "http://homeassistant.local",
              "port": 8123,
              "token": "YOUR_LONG_LIVED_ACCESS_TOKEN_HERE",
              "username": "admin",
              "insecure": 1
            }
          ],
          "default_server": 0
        }
        SERVERSEOF
        sed -i 's/^        //' release/HACompanion/servers.json.example

        cd release
        zip -r HACompanion-miyoo.zip HACompanion/

    - name: Upload Miyoo ARM artifact
      uses: actions/upload-artifact@v4
      with:
        name: HACompanion-miyoo-arm
        path: release/HACompanion-miyoo.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libcjson-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-linux-x86_64
        path: build/hacompanion

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install sdl2 sdl2_image sdl2_ttf curl sqlite cjson

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-macos
        path: build/hacompanion

  # Update v0.1.0 release with latest main branch builds
  update-dev-release:
    needs: [build-test-display, build-miyoo-arm, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        cd artifacts
        # Rename and organize files
        mv HACompanion-miyoo-arm/HACompanion-miyoo.zip ./HACompanion-miyoo.zip
        mv test-display-miyoo/test_display.zip ./test_display-miyoo.zip
        mv hacompanion-linux-x86_64/hacompanion ./hacompanion-linux-x86_64-binary
        mv hacompanion-macos/hacompanion ./hacompanion-macos-binary
        chmod +x hacompanion-linux-x86_64-binary hacompanion-macos-binary
        ls -la

    - name: Update v0.1.0 release
      run: |
        # Delete old assets
        gh release delete-asset v0.1.0 HACompanion-miyoo.zip --yes || true
        gh release delete-asset v0.1.0 test_display-miyoo.zip --yes || true
        gh release delete-asset v0.1.0 hacompanion-linux-x86_64-binary --yes || true
        gh release delete-asset v0.1.0 hacompanion-macos-binary --yes || true

        # Upload new assets
        gh release upload v0.1.0 \
          artifacts/HACompanion-miyoo.zip \
          artifacts/test_display-miyoo.zip \
          artifacts/hacompanion-linux-x86_64-binary \
          artifacts/hacompanion-macos-binary \
          --clobber

        echo "Updated v0.1.0 release with latest main branch builds"
      env:
        GH_TOKEN: ${{ github.token }}

  # Create versioned releases from tags
  release:
    needs: [build-miyoo-arm, build-linux, build-macos]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download all artifacts
      uses: actions/download-artifact@v4
      with:
        path: artifacts

    - name: Prepare release assets
      run: |
        cd artifacts
        # Rename and organize files
        mv HACompanion-miyoo-arm/HACompanion-miyoo.zip ./HACompanion-miyoo-${{ github.ref_name }}.zip
        mv hacompanion-linux-x86_64/hacompanion ./hacompanion-linux-x86_64-binary
        mv hacompanion-macos/hacompanion ./hacompanion-macos-binary
        chmod +x hacompanion-linux-x86_64-binary hacompanion-macos-binary
        ls -la

    - name: Create Release using gh CLI
      run: |
        # Delete release if it already exists
        gh release delete ${{ github.ref_name }} --yes || true

        gh release create ${{ github.ref_name }} \
          --title "HACompanion ${{ github.ref_name }}" \
          --generate-notes \
          artifacts/HACompanion-miyoo-${{ github.ref_name }}.zip \
          artifacts/hacompanion-linux-x86_64-binary \
          artifacts/hacompanion-macos-binary
      env:
        GH_TOKEN: ${{ github.token }}
