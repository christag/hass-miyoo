name: Build

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build-miyoo-arm:
    runs-on: ubuntu-latest
    container:
      image: miyoocfw/toolchain-shared-uclibc:latest

    steps:
    - uses: actions/checkout@v4

    - name: Find toolchain
      run: |
        echo "Looking for ARM GCC..."
        find /opt -name "*gcc" 2>/dev/null | head -20 || true
        find /usr -name "arm-*-gcc" 2>/dev/null | head -10 || true
        which arm-linux-gnueabihf-gcc || true
        ls -la /opt/ || true
        ls -la /opt/miyoo/ 2>/dev/null || true

    - name: Build hacompanion for Miyoo ARM
      run: |
        mkdir -p build-arm
        cd build-arm

        # Find the cross compiler
        if [ -f "/opt/miyoo/bin/arm-linux-gnueabihf-gcc" ]; then
          export CC=/opt/miyoo/bin/arm-linux-gnueabihf-gcc
          export CXX=/opt/miyoo/bin/arm-linux-gnueabihf-g++
        elif command -v arm-linux-gnueabihf-gcc &> /dev/null; then
          export CC=$(which arm-linux-gnueabihf-gcc)
          export CXX=$(which arm-linux-gnueabihf-g++)
        else
          # Search for it
          export CC=$(find /opt -name "arm-*-gcc" 2>/dev/null | head -1)
          export CXX=$(find /opt -name "arm-*-g++" 2>/dev/null | head -1)
        fi

        echo "Using CC=$CC"
        echo "Using CXX=$CXX"

        cmake -DCMAKE_C_COMPILER=$CC \
              -DCMAKE_CXX_COMPILER=$CXX \
              -DCMAKE_C_FLAGS="-march=armv7-a -mfpu=neon -mfloat-abi=hard" \
              -DCMAKE_BUILD_TYPE=Release \
              ..
        make -j$(nproc) VERBOSE=1

    - name: Create Miyoo package
      run: |
        mkdir -p release/HACompanion
        cp build-arm/hacompanion release/HACompanion/
        cp -r assets release/HACompanion/

        # Create launch script
        cat > release/HACompanion/launch.sh << 'LAUNCH_EOF'
        #!/bin/sh
        cd /mnt/SDCARD/App/HACompanion
        HOME=/mnt/SDCARD/App/HACompanion ./hacompanion
        LAUNCH_EOF
        chmod +x release/HACompanion/launch.sh

        # Create config.json for OnionOS
        cat > release/HACompanion/config.json << 'LAUNCH_EOF'
        {
          "label": "HA Companion",
          "icon": "icon.png",
          "launch": "launch.sh",
          "description": "Home Assistant Companion"
        }
        LAUNCH_EOF

        # Create sample servers.json
        cat > release/HACompanion/servers.json.example << 'LAUNCH_EOF'
        {
          "servers": [
            {
              "name": "Home",
              "url": "http://homeassistant.local",
              "port": 8123,
              "token": "YOUR_LONG_LIVED_ACCESS_TOKEN_HERE",
              "username": "admin"
            }
          ],
          "default_server": 0
        }
        LAUNCH_EOF

        cd release
        zip -r HACompanion-miyoo.zip HACompanion/

    - name: Upload Miyoo ARM artifact
      uses: actions/upload-artifact@v4
      with:
        name: HACompanion-miyoo-arm
        path: release/HACompanion-miyoo.zip

  build-linux:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          build-essential \
          cmake \
          libsdl2-dev \
          libsdl2-image-dev \
          libsdl2-ttf-dev \
          libcurl4-openssl-dev \
          libsqlite3-dev \
          libcjson-dev

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-linux-x86_64
        path: build/hacompanion

  build-macos:
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew install sdl2 sdl2_image sdl2_ttf curl sqlite cjson

    - name: Configure CMake
      run: cmake -B build -DCMAKE_BUILD_TYPE=Release

    - name: Build
      run: cmake --build build --config Release

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: hacompanion-macos
        path: build/hacompanion
