name: Build Minimal SDL2 Test (Moonlight-style)

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/moonlight-clone.yml'
  workflow_dispatch:

jobs:
  # Build a minimal SDL2 test app using moonlight's prebuilt libraries
  build-sdl-test:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Cache toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: miyoomini-toolchain.tar.xz
        key: miyoo-toolchain-v0.0.3

    - name: Download prebuilt Miyoo toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        wget -q https://github.com/shauninman/miyoomini-toolchain-buildroot/releases/download/v0.0.3/miyoomini-toolchain.tar.xz

    - name: Extract toolchain
      run: |
        sudo mkdir -p /opt
        sudo tar xf miyoomini-toolchain.tar.xz -C /opt
        ls -la /opt/miyoomini-toolchain/

    - name: Get moonlight prebuilt libraries
      run: |
        # Download moonlight app package which has working prebuilt SDL2 libs
        wget -q https://github.com/XK9274/moonlight-app-miyoo/releases/download/release1.5.1/Moonlight_Miyoo_1.5.1.tar.gz
        tar xzf Moonlight_Miyoo_1.5.1.tar.gz

        # Copy moonlight's libs to deps
        mkdir -p deps/lib deps/include
        cp moonlight/lib/*.so* deps/lib/

        # Create linker symlinks (linker looks for libSDL2.so, but file is libSDL2-2.0.so.0)
        cd deps/lib
        ln -sf libSDL2-2.0.so.0 libSDL2.so
        cd ../..

        echo "=== Moonlight libraries ==="
        ls -la deps/lib/

    - name: Get SDL2 headers from moonlight's SDL2 fork
      run: |
        # CRITICAL: Use headers from XK9274's sdl2_miyoo (moonlight branch)
        # to ensure ABI compatibility with moonlight's prebuilt SDL2 library
        git clone --depth 1 --branch moonlight https://github.com/XK9274/sdl2_miyoo.git

        # Create SDL2 subdirectory and copy headers there
        mkdir -p deps/include/SDL2
        cp -r sdl2_miyoo/include/* deps/include/SDL2/

        echo "=== SDL2 headers from sdl2_miyoo (moonlight branch) ==="
        ls -la deps/include/SDL2/ | head -20

    - name: Create minimal SDL2 test app
      run: |
        mkdir -p sdl_test
        cat > sdl_test/main.c << 'EOF'
        /*
         * Minimal SDL2 test for Miyoo Mini Plus
         * Based on moonlight's working SDL2 setup
         */
        #include <SDL2/SDL.h>
        #include <stdio.h>
        #include <stdlib.h>

        int main(int argc, char *argv[]) {
            FILE *log = fopen("sdl_test.log", "w");
            if (!log) log = stderr;

            fprintf(log, "=== Minimal SDL2 Test ===\n");
            fprintf(log, "Setting SDL_MMIYOO_DOUBLE_BUFFER before SDL_Init\n");
            fflush(log);

            // CRITICAL: Set double buffer flag BEFORE SDL_Init (like moonlight does)
            SDL_setenv("SDL_MMIYOO_DOUBLE_BUFFER", "1", 1);

            fprintf(log, "Calling SDL_Init(SDL_INIT_VIDEO)\n");
            fflush(log);

            if (SDL_Init(SDL_INIT_VIDEO) < 0) {
                fprintf(log, "SDL_Init failed: %s\n", SDL_GetError());
                fclose(log);
                return 1;
            }

            fprintf(log, "SDL_Init succeeded\n");
            fprintf(log, "Video driver: %s\n", SDL_GetCurrentVideoDriver());
            fflush(log);

            // Create window (640x480 for Miyoo)
            SDL_Window *window = SDL_CreateWindow(
                "SDL Test",
                SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED,
                640, 480,
                SDL_WINDOW_SHOWN
            );

            if (!window) {
                fprintf(log, "SDL_CreateWindow failed: %s\n", SDL_GetError());
                SDL_Quit();
                fclose(log);
                return 1;
            }

            fprintf(log, "Window created\n");
            fflush(log);

            // Create renderer with ACCELERATED (required for MMIYOO driver)
            SDL_Renderer *renderer = SDL_CreateRenderer(
                window, -1,
                SDL_RENDERER_ACCELERATED | SDL_RENDERER_PRESENTVSYNC
            );

            if (!renderer) {
                fprintf(log, "SDL_CreateRenderer failed: %s\n", SDL_GetError());
                SDL_DestroyWindow(window);
                SDL_Quit();
                fclose(log);
                return 1;
            }

            SDL_RendererInfo info;
            SDL_GetRendererInfo(renderer, &info);
            fprintf(log, "Renderer: %s, Flags: %u\n", info.name, info.flags);
            fflush(log);

            // Render loop - cycle through RED, GREEN, BLUE
            int colors[3][3] = {
                {255, 0, 0},    // RED
                {0, 255, 0},    // GREEN
                {0, 0, 255}     // BLUE
            };

            int frame = 0;
            int total_frames = 180; // 3 seconds at 60fps

            fprintf(log, "Starting render loop (%d frames)\n", total_frames);
            fflush(log);

            while (frame < total_frames) {
                int color_idx = (frame / 60) % 3;  // Change color every second

                SDL_SetRenderDrawColor(renderer,
                    colors[color_idx][0],
                    colors[color_idx][1],
                    colors[color_idx][2],
                    255);
                SDL_RenderClear(renderer);
                SDL_RenderPresent(renderer);

                SDL_Delay(16);  // ~60fps
                frame++;

                // Log progress every 60 frames
                if (frame % 60 == 0) {
                    fprintf(log, "Frame %d, color: %s\n", frame,
                        color_idx == 0 ? "RED" : (color_idx == 1 ? "GREEN" : "BLUE"));
                    fflush(log);
                }

                // Handle events (check for quit)
                SDL_Event event;
                while (SDL_PollEvent(&event)) {
                    if (event.type == SDL_QUIT) {
                        frame = total_frames;  // Exit loop
                    }
                }
            }

            fprintf(log, "Render loop complete\n");
            fprintf(log, "Cleaning up...\n");
            fflush(log);

            SDL_DestroyRenderer(renderer);
            SDL_DestroyWindow(window);
            SDL_Quit();

            fprintf(log, "=== Test Complete ===\n");
            fclose(log);

            return 0;
        }
        EOF

        echo "=== Created main.c ==="
        cat sdl_test/main.c

    - name: Compile SDL2 test
      run: |
        export PATH="/opt/miyoomini-toolchain/bin:$PATH"
        export CROSS_PREFIX="/opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-"
        export SYSROOT="/opt/miyoomini-toolchain/arm-linux-gnueabihf/libc"

        echo "=== Compiling SDL2 test ==="
        echo "Using sysroot: $SYSROOT"

        # Compile with the EXACT same flags moonlight uses, including sysroot
        # --sysroot: Use the toolchain's C library for ABI compatibility
        # --allow-shlib-undefined: SDL2 lib has many deps (EGL, GLES, etc) that
        # aren't available at link time but will be on device via LD_LIBRARY_PATH
        # Use CMake like moonlight does, to ensure exact same build process
        cat > sdl_test/CMakeLists.txt << 'CMAKE_EOF'
        cmake_minimum_required(VERSION 3.1)
        project(sdl_test C)

        set(CMAKE_C_STANDARD 99)
        set(CMAKE_C_FLAGS "${CMAKE_C_FLAGS} -Os -marm -mtune=cortex-a7 -mfpu=neon-vfpv4 -march=armv7ve+simd -mfloat-abi=hard -ffunction-sections -fdata-sections")

        add_executable(sdl_test main.c)
        target_include_directories(sdl_test PRIVATE ${CMAKE_SOURCE_DIR}/../deps/include)
        target_link_directories(sdl_test PRIVATE ${CMAKE_SOURCE_DIR}/../deps/lib)
        target_link_libraries(sdl_test SDL2 m)
        set_target_properties(sdl_test PROPERTIES LINK_FLAGS "-Wl,-rpath,'\$ORIGIN/../lib' -Wl,--allow-shlib-undefined -Wl,--gc-sections")
        CMAKE_EOF

        mkdir -p sdl_test/build
        cd sdl_test/build

        # Use moonlight's exact toolchain file approach
        cat > toolchain.cmake << 'TOOLCHAIN_EOF'
        set(CMAKE_SYSTEM_NAME Linux)
        set(CMAKE_SYSTEM_PROCESSOR armv7l)
        set(CMAKE_SYSROOT "/opt/miyoomini-toolchain/arm-linux-gnueabihf/libc")
        set(CMAKE_C_COMPILER /opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-gcc)
        set(CMAKE_CXX_COMPILER /opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-g++)
        set(CMAKE_FIND_ROOT_PATH_MODE_PROGRAM NEVER)
        set(CMAKE_FIND_ROOT_PATH_MODE_LIBRARY ONLY)
        set(CMAKE_FIND_ROOT_PATH_MODE_INCLUDE ONLY)
        TOOLCHAIN_EOF

        cmake -DCMAKE_TOOLCHAIN_FILE=toolchain.cmake ..
        make VERBOSE=1

        cp sdl_test ../sdl_test
        cd ../..

        echo "=== Compile result ==="
        file sdl_test/sdl_test
        /opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-readelf -d sdl_test/sdl_test | grep NEEDED || true

    - name: Package SDL2 test
      run: |
        mkdir -p release/sdl_test/lib

        # Copy binary
        cp sdl_test/sdl_test release/sdl_test/

        # Copy moonlight's SDL2 library (the key ingredient!)
        cp deps/lib/libSDL2-2.0.so.0 release/sdl_test/lib/

        # Create launch script - use moonlight's libs (like moonlight does)
        cat > release/sdl_test/launch.sh << 'LAUNCH_EOF'
        #!/bin/sh
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo

        cd /mnt/SDCARD/App/sdl_test

        # Use moonlight's lib directory for all dependencies (EGL, GLES, json-c, etc)
        # Our ./lib only contains SDL2, but moonlight/lib has ALL dependencies
        export LD_LIBRARY_PATH=/mnt/SDCARD/App/moonlight/lib:./lib:/lib:/config/lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte

        # Kill audio server like moonlight does
        pkill -9 -f "audioserver" 2>/dev/null || true

        echo "=== SDL Test Launch ===" > sdl_test.log
        echo "Date: $(date)" >> sdl_test.log
        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH" >> sdl_test.log

        # Run the test
        ./sdl_test >> sdl_test.log 2>&1
        echo "Exit code: $?" >> sdl_test.log
        LAUNCH_EOF
        chmod +x release/sdl_test/launch.sh

        # Create config.json for OnionOS
        cat > release/sdl_test/config.json << 'CONFIG_EOF'
        {
          "label": "SDL Test",
          "icon": "icon.png",
          "launch": "launch.sh",
          "description": "Minimal SDL2 test using moonlight libs"
        }
        CONFIG_EOF

        # Create a simple icon (1x1 red pixel PNG placeholder)
        # We'll just copy any png we can find, or skip
        find . -name "*.png" -exec cp {} release/sdl_test/icon.png \; 2>/dev/null || \
          echo "No icon found"

        echo "=== Package contents ==="
        ls -la release/sdl_test/
        ls -la release/sdl_test/lib/

        cd release
        zip -r sdl_test.zip sdl_test/

    - name: Upload SDL test artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdl-test-miyoo
        path: release/sdl_test.zip

  # Update v0.1.0 release with SDL test
  update-release:
    needs: build-sdl-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: sdl-test-miyoo
        path: artifacts

    - name: Update release
      run: |
        # Delete old asset if exists
        gh release delete-asset v0.1.0 sdl_test.zip --yes || true

        # Upload new asset
        gh release upload v0.1.0 artifacts/sdl_test.zip --clobber

        echo "Updated v0.1.0 release with SDL test"
      env:
        GH_TOKEN: ${{ github.token }}
