name: Build Minimal SDL2 Test (Moonlight-style)

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/moonlight-clone.yml'
  workflow_dispatch:

jobs:
  # Build a minimal SDL2 test app using moonlight's prebuilt libraries
  build-sdl-test:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Cache toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: miyoomini-toolchain.tar.xz
        key: miyoo-toolchain-v0.0.3

    - name: Download prebuilt Miyoo toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        wget -q https://github.com/shauninman/miyoomini-toolchain-buildroot/releases/download/v0.0.3/miyoomini-toolchain.tar.xz

    - name: Extract toolchain
      run: |
        sudo mkdir -p /opt
        sudo tar xf miyoomini-toolchain.tar.xz -C /opt
        ls -la /opt/miyoomini-toolchain/

    - name: Get moonlight prebuilt libraries
      run: |
        # Download moonlight app package which has working prebuilt SDL2 libs
        wget -q https://github.com/XK9274/moonlight-app-miyoo/releases/download/release1.5.1/Moonlight_Miyoo_1.5.1.tar.gz
        tar xzf Moonlight_Miyoo_1.5.1.tar.gz

        # Copy moonlight's libs to deps
        mkdir -p deps/lib deps/include
        cp moonlight/lib/*.so* deps/lib/

        echo "=== Moonlight libraries ==="
        ls -la deps/lib/

    - name: Get SDL2 headers
      run: |
        # Get SDL2 headers from the official SDL2 source
        wget -q https://github.com/libsdl-org/SDL/releases/download/release-2.28.5/SDL2-2.28.5.tar.gz
        tar xzf SDL2-2.28.5.tar.gz

        # Create SDL2 subdirectory and copy headers there
        mkdir -p deps/include/SDL2
        cp -r SDL2-2.28.5/include/* deps/include/SDL2/

        echo "=== SDL2 headers ==="
        ls -la deps/include/SDL2/ | head -20

    - name: Create minimal SDL2 test app
      run: |
        mkdir -p sdl_test
        cat > sdl_test/main.c << 'EOF'
        /*
         * Minimal SDL2 test for Miyoo Mini Plus
         * Based on moonlight's working SDL2 setup
         */
        #include <SDL2/SDL.h>
        #include <stdio.h>
        #include <stdlib.h>

        int main(int argc, char *argv[]) {
            FILE *log = fopen("sdl_test.log", "w");
            if (!log) log = stderr;

            fprintf(log, "=== Minimal SDL2 Test ===\n");
            fprintf(log, "Setting SDL_MMIYOO_DOUBLE_BUFFER before SDL_Init\n");
            fflush(log);

            // CRITICAL: Set double buffer flag BEFORE SDL_Init (like moonlight does)
            SDL_setenv("SDL_MMIYOO_DOUBLE_BUFFER", "1", 1);

            fprintf(log, "Calling SDL_Init(SDL_INIT_VIDEO)\n");
            fflush(log);

            if (SDL_Init(SDL_INIT_VIDEO) < 0) {
                fprintf(log, "SDL_Init failed: %s\n", SDL_GetError());
                fclose(log);
                return 1;
            }

            fprintf(log, "SDL_Init succeeded\n");
            fprintf(log, "Video driver: %s\n", SDL_GetCurrentVideoDriver());
            fflush(log);

            // Create window (640x480 for Miyoo)
            SDL_Window *window = SDL_CreateWindow(
                "SDL Test",
                SDL_WINDOWPOS_UNDEFINED, SDL_WINDOWPOS_UNDEFINED,
                640, 480,
                SDL_WINDOW_SHOWN
            );

            if (!window) {
                fprintf(log, "SDL_CreateWindow failed: %s\n", SDL_GetError());
                SDL_Quit();
                fclose(log);
                return 1;
            }

            fprintf(log, "Window created\n");
            fflush(log);

            // Create renderer with ACCELERATED (required for MMIYOO driver)
            SDL_Renderer *renderer = SDL_CreateRenderer(
                window, -1,
                SDL_RENDERER_ACCELERATED | SDL_RENDERER_PRESENTVSYNC
            );

            if (!renderer) {
                fprintf(log, "SDL_CreateRenderer failed: %s\n", SDL_GetError());
                SDL_DestroyWindow(window);
                SDL_Quit();
                fclose(log);
                return 1;
            }

            SDL_RendererInfo info;
            SDL_GetRendererInfo(renderer, &info);
            fprintf(log, "Renderer: %s, Flags: %u\n", info.name, info.flags);
            fflush(log);

            // Render loop - cycle through RED, GREEN, BLUE
            int colors[3][3] = {
                {255, 0, 0},    // RED
                {0, 255, 0},    // GREEN
                {0, 0, 255}     // BLUE
            };

            int frame = 0;
            int total_frames = 180; // 3 seconds at 60fps

            fprintf(log, "Starting render loop (%d frames)\n", total_frames);
            fflush(log);

            while (frame < total_frames) {
                int color_idx = (frame / 60) % 3;  // Change color every second

                SDL_SetRenderDrawColor(renderer,
                    colors[color_idx][0],
                    colors[color_idx][1],
                    colors[color_idx][2],
                    255);
                SDL_RenderClear(renderer);
                SDL_RenderPresent(renderer);

                SDL_Delay(16);  // ~60fps
                frame++;

                // Log progress every 60 frames
                if (frame % 60 == 0) {
                    fprintf(log, "Frame %d, color: %s\n", frame,
                        color_idx == 0 ? "RED" : (color_idx == 1 ? "GREEN" : "BLUE"));
                    fflush(log);
                }

                // Handle events (check for quit)
                SDL_Event event;
                while (SDL_PollEvent(&event)) {
                    if (event.type == SDL_QUIT) {
                        frame = total_frames;  // Exit loop
                    }
                }
            }

            fprintf(log, "Render loop complete\n");
            fprintf(log, "Cleaning up...\n");
            fflush(log);

            SDL_DestroyRenderer(renderer);
            SDL_DestroyWindow(window);
            SDL_Quit();

            fprintf(log, "=== Test Complete ===\n");
            fclose(log);

            return 0;
        }
        EOF

        echo "=== Created main.c ==="
        cat sdl_test/main.c

    - name: Compile SDL2 test
      run: |
        export PATH="/opt/miyoomini-toolchain/bin:$PATH"
        export CROSS_PREFIX="/opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-"

        echo "=== Compiling SDL2 test ==="

        # Compile with the same flags moonlight uses
        ${CROSS_PREFIX}gcc \
          -o sdl_test/sdl_test \
          sdl_test/main.c \
          -I deps/include \
          -L deps/lib \
          -Wl,-rpath,'$$ORIGIN/../lib' \
          -lSDL2 \
          -Os -marm -mtune=cortex-a7 -mfpu=neon-vfpv4 \
          -march=armv7ve+simd -mfloat-abi=hard \
          -ffunction-sections -fdata-sections \
          -Wl,--gc-sections

        echo "=== Compile result ==="
        file sdl_test/sdl_test
        ${CROSS_PREFIX}readelf -d sdl_test/sdl_test | grep NEEDED || true

    - name: Package SDL2 test
      run: |
        mkdir -p release/sdl_test/lib

        # Copy binary
        cp sdl_test/sdl_test release/sdl_test/

        # Copy moonlight's SDL2 library (the key ingredient!)
        cp deps/lib/libSDL2-2.0.so.0 release/sdl_test/lib/

        # Create launch script
        cat > release/sdl_test/launch.sh << 'LAUNCH_EOF'
        #!/bin/sh
        export SDL_VIDEODRIVER=mmiyoo
        export SDL_AUDIODRIVER=mmiyoo
        export EGL_VIDEODRIVER=mmiyoo

        cd /mnt/SDCARD/App/sdl_test
        export LD_LIBRARY_PATH=./lib:/lib:/config/lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte

        # Kill audio server like moonlight does
        pkill -9 -f "audioserver" 2>/dev/null || true

        echo "=== SDL Test Launch ===" > sdl_test.log
        echo "Date: $(date)" >> sdl_test.log
        echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH" >> sdl_test.log

        # Run the test
        ./sdl_test >> sdl_test.log 2>&1
        echo "Exit code: $?" >> sdl_test.log
        LAUNCH_EOF
        chmod +x release/sdl_test/launch.sh

        # Create config.json for OnionOS
        cat > release/sdl_test/config.json << 'CONFIG_EOF'
        {
          "label": "SDL Test",
          "icon": "icon.png",
          "launch": "launch.sh",
          "description": "Minimal SDL2 test using moonlight libs"
        }
        CONFIG_EOF

        # Create a simple icon (1x1 red pixel PNG placeholder)
        # We'll just copy any png we can find, or skip
        find . -name "*.png" -exec cp {} release/sdl_test/icon.png \; 2>/dev/null || \
          echo "No icon found"

        echo "=== Package contents ==="
        ls -la release/sdl_test/
        ls -la release/sdl_test/lib/

        cd release
        zip -r sdl_test.zip sdl_test/

    - name: Upload SDL test artifact
      uses: actions/upload-artifact@v4
      with:
        name: sdl-test-miyoo
        path: release/sdl_test.zip

  # Update v0.1.0 release with SDL test
  update-release:
    needs: build-sdl-test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: sdl-test-miyoo
        path: artifacts

    - name: Update release
      run: |
        # Delete old asset if exists
        gh release delete-asset v0.1.0 sdl_test.zip --yes || true

        # Upload new asset
        gh release upload v0.1.0 artifacts/sdl_test.zip --clobber

        echo "Updated v0.1.0 release with SDL test"
      env:
        GH_TOKEN: ${{ github.token }}
