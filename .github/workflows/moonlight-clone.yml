name: Build Moonlight Clone

on:
  push:
    branches: [ main, master ]
    paths:
      - '.github/workflows/moonlight-clone.yml'
  workflow_dispatch:

jobs:
  # Build moonlight-embedded-miyoo from source using the same toolchain as XK9274
  build-moonlight:
    runs-on: ubuntu-22.04

    steps:
    - uses: actions/checkout@v4

    - name: Cache toolchain
      id: cache-toolchain
      uses: actions/cache@v4
      with:
        path: miyoomini-toolchain.tar.xz
        key: miyoo-toolchain-v0.0.3

    - name: Download prebuilt Miyoo toolchain
      if: steps.cache-toolchain.outputs.cache-hit != 'true'
      run: |
        wget -q https://github.com/shauninman/miyoomini-toolchain-buildroot/releases/download/v0.0.3/miyoomini-toolchain.tar.xz

    - name: Extract toolchain
      run: |
        sudo mkdir -p /opt
        sudo tar xf miyoomini-toolchain.tar.xz -C /opt
        ls -la /opt/

    - name: Install build dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y cmake ninja-build pkg-config

    - name: Clone moonlight-embedded-miyoo
      run: |
        git clone --recursive https://github.com/XK9274/moonlight-embedded-miyoo.git
        cd moonlight-embedded-miyoo
        git submodule update --init --recursive
        ls -la

    - name: Get prebuilt dependencies from moonlight-app-miyoo
      run: |
        # Download the full moonlight app package which has all prebuilt libs
        # Note: tag is "release1.5.1" and file is "Moonlight_Miyoo_1.5.1.tar.gz"
        wget -q https://github.com/XK9274/moonlight-app-miyoo/releases/download/release1.5.1/Moonlight_Miyoo_1.5.1.tar.gz
        tar xzf Moonlight_Miyoo_1.5.1.tar.gz
        ls -la
        # Find and list the lib directory
        find . -type d -name lib | head -5
        find . -name "*.so*" | head -20

        # These are the prebuilt libraries that moonlight uses
        # We'll use them for linking - adjust path based on actual structure
        mkdir -p deps/lib deps/include
        # Copy from wherever the libs are found
        find . -name "*.so*" -exec cp {} deps/lib/ \; 2>/dev/null || true
        ls -la deps/lib/

    - name: Set up cross-compile environment
      run: |
        export CROSS_PREFIX=/opt/miyoomini-toolchain/bin/arm-linux-gnueabihf-
        export SYSROOT=/opt/miyoomini-toolchain/arm-linux-gnueabihf/sysroot

        echo "=== Toolchain info ==="
        ${CROSS_PREFIX}gcc --version

        # Set up pkg-config for cross-compilation
        export PKG_CONFIG_PATH=$PWD/deps/lib/pkgconfig:/opt/miyoomini-toolchain/arm-linux-gnueabihf/sysroot/usr/lib/pkgconfig
        export PKG_CONFIG_SYSROOT_DIR=$SYSROOT

        echo "CROSS_PREFIX=${CROSS_PREFIX}" >> $GITHUB_ENV
        echo "SYSROOT=${SYSROOT}" >> $GITHUB_ENV
        echo "PKG_CONFIG_PATH=${PKG_CONFIG_PATH}" >> $GITHUB_ENV

    - name: Build moonlight-embedded-miyoo
      run: |
        # Add toolchain to PATH so CMake can find arm-linux-gnueabihf-gcc
        export PATH="/opt/miyoomini-toolchain/bin:$PATH"

        cd moonlight-embedded-miyoo

        # Create build directory
        mkdir -p build
        cd build

        # Configure with CMake using the cross-compilation toolchain
        # Note: Moonlight's CMakeLists.txt has specific flags for Miyoo
        cmake .. \
          -DCMAKE_TOOLCHAIN_FILE=../armv7l-toolchain.cmake \
          -DCMAKE_BUILD_TYPE=Release \
          -DENABLE_X11=OFF \
          -DENABLE_PULSE=OFF \
          -DENABLE_CEC=OFF \
          -DCMAKE_C_FLAGS="-Wno-undef -Os -marm -mtune=cortex-a7 -mfpu=neon-vfpv4 -march=armv7ve+simd -mfloat-abi=hard -ffunction-sections -fdata-sections -I/opt/miyoomini-toolchain/arm-linux-gnueabihf/sysroot/usr/include" \
          -DCMAKE_EXE_LINKER_FLAGS="-L$PWD/../../deps/lib -L/opt/miyoomini-toolchain/arm-linux-gnueabihf/sysroot/usr/lib"

        # Build
        make -j$(nproc) VERBOSE=1 || {
          echo "=== Build failed, showing details ==="
          cat CMakeFiles/CMakeError.log || true
          cat CMakeFiles/CMakeOutput.log || true
          exit 1
        }

        echo "=== Build output ==="
        ls -la
        file moonlight || true

    - name: Package moonlight clone
      run: |
        mkdir -p release/moonlight-clone/bin
        mkdir -p release/moonlight-clone/lib

        # Copy built binary
        cp moonlight-embedded-miyoo/build/moonlight release/moonlight-clone/bin/ || {
          echo "Moonlight binary not found, checking for alternative locations..."
          find moonlight-embedded-miyoo -name "moonlight" -type f | head -5
          exit 1
        }

        # Copy libraries from moonlight app (these work on the device)
        # Libraries were copied to deps/lib/ in the earlier step
        cp deps/lib/*.so* release/moonlight-clone/lib/ || true

        # Create launch script (based on original moonlight launch.sh)
        # Using printf to avoid YAML heredoc parsing issues
        printf '%s\n' '#!/bin/sh' > release/moonlight-clone/launch.sh
        printf '%s\n' 'export moonlightdir=/mnt/SDCARD/App/moonlight-clone' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'cd $moonlightdir' >> release/moonlight-clone/launch.sh
        printf '%s\n' '' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'export PATH=$PATH:$PWD/bin' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'export HOME=$moonlightdir' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'export LD_LIBRARY_PATH=./lib:/lib:/config/lib:/mnt/SDCARD/miyoo/lib:/mnt/SDCARD/.tmp_update/lib:/mnt/SDCARD/.tmp_update/lib/parasyte' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'export SDL_VIDEODRIVER=mmiyoo' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'export SDL_AUDIODRIVER=mmiyoo' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'export EGL_VIDEODRIVER=mmiyoo' >> release/moonlight-clone/launch.sh
        printf '%s\n' '' >> release/moonlight-clone/launch.sh
        printf '%s\n' '# Kill audio servers like moonlight does' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'pkill -9 -f "audioserver" 2>/dev/null || true' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'killall -q "audioserver.mod" 2>/dev/null || true' >> release/moonlight-clone/launch.sh
        printf '%s\n' '' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'echo "=== Moonlight Clone Launch ===" > moonlight-clone.log' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'echo "Date: $(date)" >> moonlight-clone.log' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'echo "LD_LIBRARY_PATH: $LD_LIBRARY_PATH" >> moonlight-clone.log' >> release/moonlight-clone/launch.sh
        printf '%s\n' '' >> release/moonlight-clone/launch.sh
        printf '%s\n' '# Run moonlight (menu mode for testing)' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'LD_PRELOAD="./lib/libuuid.so" ./bin/moonlight -help >> moonlight-clone.log 2>&1' >> release/moonlight-clone/launch.sh
        printf '%s\n' 'echo "Exit code: $?" >> moonlight-clone.log' >> release/moonlight-clone/launch.sh
        chmod +x release/moonlight-clone/launch.sh

        # Create config.json for OnionOS
        printf '%s\n' '{' > release/moonlight-clone/config.json
        printf '%s\n' '  "label": "Moonlight Clone",' >> release/moonlight-clone/config.json
        printf '%s\n' '  "icon": "icon.png",' >> release/moonlight-clone/config.json
        printf '%s\n' '  "launch": "launch.sh",' >> release/moonlight-clone/config.json
        printf '%s\n' '  "description": "Moonlight clone build test"' >> release/moonlight-clone/config.json
        printf '%s\n' '}' >> release/moonlight-clone/config.json

        # Copy icon from original moonlight if available
        # Try to find icon in the extracted moonlight package
        find . -name "*.png" -path "*res*" -exec cp {} release/moonlight-clone/icon.png \; 2>/dev/null || \
          echo "No icon found, will use default"

        ls -la release/moonlight-clone/
        ls -la release/moonlight-clone/bin/
        ls -la release/moonlight-clone/lib/

        cd release
        zip -r moonlight-clone.zip moonlight-clone/

    - name: Upload moonlight clone artifact
      uses: actions/upload-artifact@v4
      with:
        name: moonlight-clone-miyoo
        path: release/moonlight-clone.zip

  # Update v0.1.0 release with moonlight clone
  update-release:
    needs: build-moonlight
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    permissions:
      contents: write

    steps:
    - uses: actions/checkout@v4

    - name: Download artifact
      uses: actions/download-artifact@v4
      with:
        name: moonlight-clone-miyoo
        path: artifacts

    - name: Update release
      run: |
        # Delete old asset if exists
        gh release delete-asset v0.1.0 moonlight-clone.zip --yes || true

        # Upload new asset
        gh release upload v0.1.0 artifacts/moonlight-clone.zip --clobber

        echo "Updated v0.1.0 release with moonlight clone"
      env:
        GH_TOKEN: ${{ github.token }}
